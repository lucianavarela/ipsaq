<section class="hero is-light">
  <div class="hero-body has-text-centered">
    <button class="button is-small is-link hero-mb-1em" (click)="showSummary = !showSummary">
      <span class="icon"><i class="fa" [ngClass]="
            showSummary ? 'fa-chevron-up' : 'fa-chevron-down'
          "></i></span>
      <span>{{ showSummary ? "Ocultar" : "Ver" }} próximos
        designados</span>
    </button>
    <button class="button is-small is-success hero-mb-1em ml-1rem" (click)="openAddSpecialDate()">
      <span class="icon"><i class="fa fa-plus"></i></span>
      <span>Agregar día especial</span>
    </button>
    <div *ngIf="showAddSpecialDate" class="add-special-date-form">
      <input type="date" [(ngModel)]="newSpecialDate" class="input is-small special-date-input" />
      <button class="button is-small is-primary ml-1rem" (click)="addSpecialDate()">
        Guardar
      </button>
      <button class="button is-small ml-1rem" (click)="showAddSpecialDate = false">
        Cancelar
      </button>
    </div>
    <div *ngIf="showSummary" class="overflow-x-auto">
      <div class="flex-gap-2em-wrap-center">
        <div *ngFor="let date of sermonDates | slice : 0 : 4" class="minw-180px">
          <div class="bold-mb-03em-capitalize">
            {{ date | date : "EEEE dd/MM" }}
          </div>
          <div class="fs-097-mb-02em">
            <span *ngIf="getDirectorName(date)">Director: {{ getDirectorName(date) }}</span>
          </div>
          <div class="fs-097-mb-02em">
            <span class="weight-500">Músicos:</span>
            <span *ngIf="
                getDesignatedBySection(date).instruments.length;
                else noMusicos
              ">
              {{ getDesignatedBySection(date).instruments.join(", ") }}
            </span>
            <ng-template #noMusicos><span class="text-muted">-</span></ng-template>
          </div>
          <div class="fs-097">
            <span class="weight-500">Coro:</span>
            <span *ngIf="getDesignatedBySection(date).choir.length; else noCoro">
              {{ getDesignatedBySection(date).choir.join(", ") }}
            </span>
            <ng-template #noCoro><span class="text-muted"> -</span></ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="planning-table">
  <table>
    <thead>
      <tr>
        <th rowspan="2">Mes</th>
        <th rowspan="2">Fecha</th>
        <th rowspan="2">Director</th>
        <th colspan="2">Instrumentos</th>
        <th colspan="2">Coro</th>
      </tr>
      <tr>
        <th>Disponibles</th>
        <th>Ausentes</th>
        <th>Disponibles</th>
        <th>Ausentes</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let month of months">
        <tr *ngFor="let date of month.dates; let i = index">
          <td *ngIf="i === 0" [attr.rowspan]="month.dates.length" class="month-cell">
            {{ month.name | titlecase }}
          </td>
          <td class="date-cell">{{ date | date : "EEEE dd" }}</td>
          <td class="directing-cell cell-container">
            <span *ngIf="grouped[date]?.directing && grouped[date].directing?.id" class="profile-tag"
              [attr.data-color]="grouped[date].directing?.id | profileColor"
              [style.--tag-color]="grouped[date].directing?.id | profileColor"
              [style.--tag-bg]="grouped[date].directing?.id | profileColor:0.2">
              {{ grouped[date].directing?.nickname }}
            </span>
            <button class="button is-small is-ghost"
              (click)="openAddProfile('directing', 'unique', date)">
              <span class="icon is-small has-text-success"><i class="fa fa-plus"></i></span>
            </button>
            <div
              *ngIf="showAddProfile['directing-unique-' + date]"
              class="add-profile-form"
              [attr.data-add-profile-key]="'directing-unique-' + date"
            >
              <div class="field has-addons is-pulled-right">
                <div class="control">
                  <div class="select is-small directing">
                    <select [ngModel]="selectedProfileId['directing-unique-' + date]" (ngModelChange)="selectedProfileId['directing-unique-' + date] = $event">
                      <option [value]="null">Elegir</option>
                      <option *ngFor="let p of getProfilesForSection('directing')" [value]="p.id">
                        {{ p.nickname }}
                      </option>
                    </select>
                  </div>
                </div>
                <div class="control">
                  <button class="button is-small is-success" [disabled]="!selectedProfileId['directing-unique-' + date]" (click)="addProfileToDirecting(date)">
                    <span class="icon is-small has-text-white"><i class="fa fa-check"></i></span>
                  </button>
                </div>
              </div>
            </div>
          </td>
          <td class="cell-container">
            <app-availability-cell
              [profiles]="grouped[date].instruments.available | orderByName"
              [profileOptions]="getProfilesForSection('instruments')"
              [availabilities]="availabilities"
              [date]="date"
              type="available"
              section="instruments"
              [showAddForm]="showAddProfile['instruments-available-' + date]"
              [selectedProfileId]="selectedProfileId['instruments-available-' + date]"
              (showFormChange)="openAddProfile('instruments', 'available', date)"
              (selectedProfileChange)="selectedProfileId['instruments-available-' + date] = $event"
              (addProfile)="addProfileToCell('instruments', 'available', date)"
              (toggleDesignated)="onToggleDesignated($event)"
            ></app-availability-cell>
          </td>
          <td class="cell-container">
            <app-availability-cell
              [profiles]="grouped[date].instruments.absent | orderByName"
              [profileOptions]="getProfilesForSection('instruments')"
              [date]="date"
              type="absent"
              section="instruments"
              [showAddForm]="showAddProfile['instruments-absent-' + date]"
              [selectedProfileId]="selectedProfileId['instruments-absent-' + date]"
              (showFormChange)="openAddProfile('instruments', 'absent', date)"
              (selectedProfileChange)="selectedProfileId['instruments-absent-' + date] = $event"
              (addProfile)="addProfileToCell('instruments', 'absent', date)"
            ></app-availability-cell>
          </td>
          <td class="cell-container">
            <app-availability-cell
              [profiles]="grouped[date].choir.available | orderByName"
              [profileOptions]="getProfilesForSection('choir')"
              [availabilities]="availabilities"
              [date]="date"
              type="available"
              section="choir"
              [showAddForm]="showAddProfile['choir-available-' + date]"
              [selectedProfileId]="selectedProfileId['choir-available-' + date]"
              (showFormChange)="openAddProfile('choir', 'available', date)"
              (selectedProfileChange)="selectedProfileId['choir-available-' + date] = $event"
              (addProfile)="addProfileToCell('choir', 'available', date)"
              (toggleDesignated)="onToggleDesignated($event)"
            ></app-availability-cell>
          </td>
          <td class="cell-container">
            <app-availability-cell
              [profiles]="grouped[date].choir.absent | orderByName"
              [profileOptions]="getProfilesForSection('choir')"
              [date]="date"
              type="absent"
              section="choir"
              [showAddForm]="showAddProfile['choir-absent-' + date]"
              [selectedProfileId]="selectedProfileId['choir-absent-' + date]"
              (showFormChange)="openAddProfile('choir', 'absent', date)"
              (selectedProfileChange)="selectedProfileId['choir-absent-' + date] = $event"
              (addProfile)="addProfileToCell('choir', 'absent', date)"
            ></app-availability-cell>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</div>